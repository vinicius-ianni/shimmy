# Vision Testing Container - macOS Cross-Compilation Validation
FROM ubuntu:22.04

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    pkg-config \
    libssl-dev \
    libclang-dev \
    git \
    curl \
    python3 \
    python3-pip \
    clang \
    llvm \
    && rm -rf /var/lib/apt/lists/*

# Install Rust with macOS targets
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"
RUN rustup target add x86_64-apple-darwin aarch64-apple-darwin

# Install macOS SDK and cross-compilation tools
RUN apt-get update && apt-get install -y \
    libxml2-dev \
    libz-dev \
    && rm -rf /var/lib/apt/lists/*

# Install osxcross for macOS cross-compilation
RUN git clone https://github.com/tpoechtrager/osxcross && \
    cd osxcross && \
    wget -nc https://s3.dockerproject.org/darwin/v2/MacOSX10.10.sdk.tar.xz && \
    mv MacOSX10.10.sdk.tar.xz tarballs/ && \
    UNATTENDED=yes OSX_VERSION_MIN=10.10 ./build.sh && \
    cd .. && rm -rf osxcross

ENV PATH="/opt/osxcross/target/bin:${PATH}"

# Set working directory
WORKDIR /workspace

# Copy source code
COPY . .

# Create test script for macOS cross-compilation
RUN cat > /workspace/run_vision_tests.sh << 'EOF'
#!/bin/bash
set -e

echo "ðŸ§ª Starting Vision Cross-Platform Tests"
echo "Platform: macOS (Cross-Compilation Validation)"
echo "=============================================="

# Test Intel macOS build
echo "ðŸŽ Testing macOS Intel (x86_64) build..."
cargo build --release --target x86_64-apple-darwin --features llama,vision,mlx
echo "âœ… macOS Intel build successful"

# Test Apple Silicon macOS build
echo "ðŸŽ Testing macOS ARM64 (Apple Silicon) build..."
cargo build --release --target aarch64-apple-darwin --features llama,vision,mlx
echo "âœ… macOS ARM64 build successful"

# Validate vision features are included
echo "ðŸ” Validating vision features..."
for target in x86_64-apple-darwin aarch64-apple-darwin; do
    binary="target/${target}/release/shimmy"
    if [ -f "$binary" ]; then
        echo "âœ… Binary exists: $binary"

        # Check if vision command is available (basic check)
        if "$binary" --help | grep -q vision; then
            echo "âœ… Vision command available in $target binary"
        else
            echo "âŒ Vision command missing in $target binary"
            exit 1
        fi
    else
        echo "âŒ Binary missing: $binary"
        exit 1
    fi
done

# Create test report
cat > /workspace/test-results-macos-cross.json << JSON_EOF
{
    "platform": "macOS (Cross-Compilation)",
    "targets": ["x86_64-apple-darwin", "aarch64-apple-darwin"],
    "build_status": "success",
    "vision_features": "included",
    "timestamp": "$(date -Iseconds)",
    "notes": [
        "Cross-compilation successful",
        "Vision features properly included",
        "MLX support enabled for Apple Silicon",
        "Manual testing required on actual macOS hardware"
    ]
}
JSON_EOF

echo "âœ… macOS cross-compilation validation completed"
echo "ðŸ“‹ Test report saved to: /workspace/test-results-macos-cross.json"
echo ""
echo "âš ï¸ REMINDER: Manual testing required on actual macOS hardware"
echo "   for Apple Silicon (MLX) and Intel (MLX/x86_64) platforms"
EOF

RUN chmod +x /workspace/run_vision_tests.sh

# Default command
CMD ["/workspace/run_vision_tests.sh"]