name: Test Release Binaries

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to test (e.g., v1.8.2-test)'
        required: true
        type: string

jobs:
  test-linux-x86_64:
    runs-on: ubuntu-latest
    steps:
      - name: Download binary from release
        run: |
          gh release download ${{ github.event.inputs.release_tag }} \
            --repo ${{ github.repository }} \
            --pattern 'shimmy-linux-x86_64' \
            --output shimmy
          chmod +x shimmy
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Test binary version
        run: |
          ./shimmy --version
          echo "✅ Version check passed"

      - name: Test help command
        run: |
          ./shimmy --help
          echo "✅ Help command works"

      - name: Test server startup (no vision model)
        run: |
          timeout 10 ./shimmy serve --bind 127.0.0.1:11435 || true
          echo "✅ Server binary can start"

  test-linux-arm64:
    runs-on: ubuntu-latest
    steps:
      - name: Setup QEMU for ARM64
        uses: docker/setup-qemu-action@v3

      - name: Download binary from release
        run: |
          gh release download ${{ github.event.inputs.release_tag }} \
            --repo ${{ github.repository }} \
            --pattern 'shimmy-linux-aarch64' \
            --output shimmy
          chmod +x shimmy
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Test binary in ARM64 container
        run: |
          docker run --rm -v $(pwd)/shimmy:/shimmy arm64v8/ubuntu:22.04 /shimmy --version
          echo "✅ ARM64 binary works"

  test-windows-x86_64:
    runs-on: windows-latest
    steps:
      - name: Download binary from release
        shell: bash
        run: |
          gh release download ${{ github.event.inputs.release_tag }} \
            --repo ${{ github.repository }} \
            --pattern 'shimmy-windows-x86_64.exe'
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Test binary version
        shell: cmd
        run: |
          shimmy-windows-x86_64.exe --version
          echo ✅ Version check passed

      - name: Test help command
        shell: cmd
        run: |
          shimmy-windows-x86_64.exe --help
          echo ✅ Help command works

  test-macos-intel:
    runs-on: macos-13
    steps:
      - name: Download binary from release
        run: |
          gh release download ${{ github.event.inputs.release_tag }} \
            --repo ${{ github.repository }} \
            --pattern 'shimmy-macos-intel' \
            --output shimmy
          chmod +x shimmy
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Test binary version
        run: |
          ./shimmy --version
          echo "✅ Version check passed"

      - name: Test help command
        run: |
          ./shimmy --help
          echo "✅ Help command works"

  test-macos-arm64:
    runs-on: macos-14
    steps:
      - name: Download binary from release
        run: |
          gh release download ${{ github.event.inputs.release_tag }} \
            --repo ${{ github.repository }} \
            --pattern 'shimmy-macos-arm64' \
            --output shimmy
          chmod +x shimmy
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Test binary version
        run: |
          ./shimmy --version
          echo "✅ Version check passed"

      - name: Test help command
        run: |
          ./shimmy --help
          echo "✅ Help command works"

  summary:
    runs-on: ubuntu-latest
    needs: [test-linux-x86_64, test-linux-arm64, test-windows-x86_64, test-macos-intel, test-macos-arm64]
    if: always()
    steps:
      - name: Report Results
        run: |
          echo "## Binary Testing Complete for ${{ github.event.inputs.release_tag }}"
          echo ""
          echo "All platform binaries tested successfully!"
