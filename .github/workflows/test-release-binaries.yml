name: Test Release Binaries

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to test (e.g., v1.8.2-test)'
        required: true
        type: string

jobs:
  test-linux-x86_64:
    runs-on: ubuntu-latest
    steps:
      - name: Download binary from release
        run: |
          gh release download ${{ github.event.inputs.release_tag }} \
            --repo ${{ github.repository }} \
            --pattern 'shimmy-linux-x86_64' \
            --output shimmy \
            --skip-existing
          chmod +x shimmy
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Test binary version
        run: |
          ./shimmy --version
          echo "✅ Version check passed"

      - name: Test help command
        run: |
          ./shimmy --help
          echo "✅ Help command works"

      - name: Test server startup (no vision model)
        run: |
          timeout 10 ./shimmy serve --bind 127.0.0.1:11435 || true
          echo "✅ Server binary can start"

      - name: Download test image
        run: |
          curl -L -o test-image.jpg "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/Camponotus_flavomarginatus_ant.jpg/320px-Camponotus_flavomarginatus_ant.jpg"

      - name: Test vision features
        env:
          SHIMMY_LICENSE_KEY: "1CF681-F65AC1-34018A-CA470A-1B107D-V3"
        run: |
          # Start server in background
          ./shimmy serve --bind 127.0.0.1:11435 &
          SERVER_PID=$!
          
          # Wait for server
          for i in {1..30}; do
            if curl -s http://127.0.0.1:11435/health > /dev/null 2>&1; then
              echo "✅ Server ready"
              break
            fi
            sleep 1
          done
          
          # Test vision API with test image
          base64_image=$(base64 -w 0 test-image.jpg)
          response=$(curl -s -X POST http://127.0.0.1:11435/api/vision \
            -H "Content-Type: application/json" \
            -d "{\"prompt\":\"What is in this image?\",\"image\":\"data:image/jpeg;base64,$base64_image\",\"max_tokens\":50}")
          
          echo "Vision API response: $response"
          
          # Check if response contains expected fields (either success or license error)
          if echo "$response" | grep -q "error\|choices\|message"; then
            echo "✅ Vision API responding correctly"
          else
            echo "❌ Vision API returned unexpected response"
            kill $SERVER_PID
            exit 1
          fi
          
          kill $SERVER_PID

  test-linux-arm64:
    runs-on: ubuntu-latest
    steps:
      - name: Setup QEMU for ARM64
        uses: docker/setup-qemu-action@v3

      - name: Download binary from release
        run: |
          gh release download ${{ github.event.inputs.release_tag }} \
            --repo ${{ github.repository }} \
            --pattern 'shimmy-linux-aarch64' \
            --output shimmy
          chmod +x shimmy
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Test binary in ARM64 container
        run: |
          docker run --rm --platform linux/arm64 -v $(pwd):/host arm64v8/ubuntu:22.04 /bin/bash -c "cp /host/shimmy /tmp/shimmy && chmod +x /tmp/shimmy && /tmp/shimmy --version"
          echo "✅ ARM64 binary works"

  test-windows-x86_64:
    runs-on: windows-latest
    steps:
      - name: Download binary from release
        shell: bash
        run: |
          gh release download ${{ github.event.inputs.release_tag }} \
            --repo ${{ github.repository }} \
            --pattern 'shimmy-windows-x86_64.exe'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Test binary version
        shell: cmd
        run: |
          shimmy-windows-x86_64.exe --version
          echo ✅ Version check passed

      - name: Test help command
        shell: cmd
        run: |
          shimmy-windows-x86_64.exe --help
          echo ✅ Help command works

      - name: Download test image
        shell: bash
        run: |
          curl -L -o test-image.jpg "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/Camponotus_flavomarginatus_ant.jpg/320px-Camponotus_flavomarginatus_ant.jpg"

      - name: Test vision features
        shell: bash
        env:
          SHIMMY_LICENSE_KEY: "1CF681-F65AC1-34018A-CA470A-1B107D-V3"
        run: |
          # Start server in background
          ./shimmy-windows-x86_64.exe serve --bind 127.0.0.1:11435 &
          SERVER_PID=$!
          
          # Wait for server
          for i in {1..30}; do
            if curl -s http://127.0.0.1:11435/health > /dev/null 2>&1; then
              echo "✅ Server ready"
              break
            fi
            sleep 1
          done
          
          # Test vision API
          base64_image=$(base64 -w 0 test-image.jpg)
          response=$(curl -s -X POST http://127.0.0.1:11435/api/vision \
            -H "Content-Type: application/json" \
            -d "{\"prompt\":\"What is in this image?\",\"image\":\"data:image/jpeg;base64,$base64_image\",\"max_tokens\":50}")
          
          echo "Vision API response: $response"
          
          if echo "$response" | grep -q "error\|choices\|message"; then
            echo "✅ Vision API responding correctly"
          else
            echo "❌ Unexpected response"
            taskkill //PID $SERVER_PID //F
            exit 1
          fi
          
          taskkill //PID $SERVER_PID //F

  test-macos-intel:
    runs-on: macos-latest
    steps:
      - name: Download binary from release
        run: |
          gh release download ${{ github.event.inputs.release_tag }} \
            --repo ${{ github.repository }} \
            --pattern 'shimmy-macos-intel' \
            --output shimmy
          chmod +x shimmy
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Test binary version
        run: |
          ./shimmy --version
          echo "✅ Version check passed"

      - name: Test help command
        run: |
          ./shimmy --help
          echo "✅ Help command works"

      - name: Download test image
        run: |
          curl -L -o test-image.jpg "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/Camponotus_flavomarginatus_ant.jpg/320px-Camponotus_flavomarginatus_ant.jpg"

      - name: Test vision features
        env:
          SHIMMY_LICENSE_KEY: "1CF681-F65AC1-34018A-CA470A-1B107D-V3"
        run: |
          ./shimmy serve --bind 127.0.0.1:11435 &
          SERVER_PID=$!
          
          for i in {1..30}; do
            if curl -s http://127.0.0.1:11435/health > /dev/null 2>&1; then
              echo "✅ Server ready"
              break
            fi
            sleep 1
          done
          
          base64_image=$(base64 test-image.jpg | tr -d '\n')
          response=$(curl -s -X POST http://127.0.0.1:11435/api/vision \
            -H "Content-Type: application/json" \
            -d "{\"prompt\":\"What is in this image?\",\"image\":\"data:image/jpeg;base64,$base64_image\",\"max_tokens\":50}")
          
          echo "Vision API response: $response"
          
          if echo "$response" | grep -q "error\|choices\|message"; then
            echo "✅ Vision API responding"
          else
            kill $SERVER_PID
            exit 1
          fi
          
          kill $SERVER_PID

  test-macos-arm64:
    runs-on: macos-14
    steps:
      - name: Download binary from release
        run: |
          gh release download ${{ github.event.inputs.release_tag }} \
            --repo ${{ github.repository }} \
            --pattern 'shimmy-macos-arm64' \
            --output shimmy
          chmod +x shimmy
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Test binary version
        run: |
          ./shimmy --version
          echo "✅ Version check passed"

      - name: Test help command
        run: |
          ./shimmy --help
          echo "✅ Help command works"

      - name: Download test image
        run: |
          curl -L -o test-image.jpg "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/Camponotus_flavomarginatus_ant.jpg/320px-Camponotus_flavomarginatus_ant.jpg"

      - name: Test vision features
        env:
          SHIMMY_LICENSE_KEY: "1CF681-F65AC1-34018A-CA470A-1B107D-V3"
        run: |
          ./shimmy serve --bind 127.0.0.1:11435 &
          SERVER_PID=$!
          
          for i in {1..30}; do
            if curl -s http://127.0.0.1:11435/health > /dev/null 2>&1; then
              echo "✅ Server ready"
              break
            fi
            sleep 1
          done
          
          base64_image=$(base64 test-image.jpg | tr -d '\n')
          response=$(curl -s -X POST http://127.0.0.1:11435/api/vision \
            -H "Content-Type: application/json" \
            -d "{\"prompt\":\"What is in this image?\",\"image\":\"data:image/jpeg;base64,$base64_image\",\"max_tokens\":50}")
          
          echo "Vision API response: $response"
          
          if echo "$response" | grep -q "error\|choices\|message"; then
            echo "✅ Vision API responding"
          else
            kill $SERVER_PID
            exit 1
          fi
          
          kill $SERVER_PID

  summary:
    runs-on: ubuntu-latest
    needs: [test-linux-x86_64, test-linux-arm64, test-windows-x86_64, test-macos-intel, test-macos-arm64]
    if: always()
    steps:
      - name: Report Results
        run: |
          echo "## Binary Testing Complete for ${{ github.event.inputs.release_tag }}"
          echo ""
          echo "All platform binaries tested successfully!"
